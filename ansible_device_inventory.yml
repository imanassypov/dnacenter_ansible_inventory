---
  - name: Ansible Network Device Inventory
    hosts: localhost
    connection: local
    gather_facts: false
    vars_files:
      - credentials.yml
      - params.yml
    vars:
      dnac_host: "{{dnac_host}}"
      dnac_username: "{{username}}"
      dnac_password: "{{password}}"
      deviceFamily: "{{deviceFamily}}"
      siteId: "d88cc44e-9b5e-4bd7-9df1-c96afa7a38a9"
      dnac_login: &dnac_login
        dnac_host: "{{dnac_host}}"
        dnac_username: "{{dnac_username}}"
        dnac_password: "{{dnac_password}}"
        dnac_version: 2.2.2.3
        dnac_verify: False
        dnac_debug: False

    tasks:
    - name: Get start timestamp from the system
      shell: "date +%Y-%m-%dT%H-%M-%S"
      register: timestamp
      delegate_to: localhost

    - name: Print playbook start timestamp
      ansible.builtin.debug:
        msg: "Playbook start time: {{timestamp.stdout}}"

    - name: Gather membership info
      cisco.dnac.site_membership_info:
        <<: *dnac_login
        siteId: "{{siteId}}"
        deviceFamily: "{{item}}"
      register: membership_info
      with_items: "{{deviceFamily}}"
      no_log: true

    - name: Initialize Device List
      set_fact:
        device_list: []

    - name: Display membership info
      set_fact:
        device_list: "{{ device_list + item.1.response }}"
      with_subelements: 
         - "{{membership_info.results}}"
         - dnac_response.device
      loop_control:
        label: ""
      no_log: true

    - name: Display Device info
      ansible.builtin.debug:
        msg: "{{device_list}}"

    - name: Get end timestamp from the system
      shell: "date +%Y-%m-%dT%H-%M-%S"
      register: timestamp
      delegate_to: localhost

    - name: Print timestamp
      ansible.builtin.debug:
        msg: "Playbook end time: {{timestamp.stdout}}"